// ==UserScript==
// @nameÂ  Â  Â  Â  Â Elearn solver 
// @namespaceÂ  Â  moodle.ai.solver.flash2.clean.summary
// @versionÂ  Â  Â  4.8
// @descriptionÂ  This is a secret shhhhhh ctrl+shift+f to turn on the UI then enter your API key
// @matchÂ  Â  Â  Â  https://elearning.tdtu.edu.vn/mod/quiz/*
// @connectÂ  Â  Â  generativelanguage.googleapis.com
// @grantÂ  Â  Â  Â  GM_xmlhttpRequest
// @grantÂ  Â  Â  Â  GM_setValue
// @grantÂ  Â  Â  Â  GM_getValue
// ==/UserScript==

(function() {
Â  Â  'use strict';

Â  Â  const MODEL_ID = "gemini-2.0-flash-lite";
Â  Â  const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_ID}:generateContent`;

Â  Â  function addUI() {
Â  Â  Â  Â  if (document.getElementById('aiSolverBox')) return;

Â  Â  Â  Â 
Â  Â  Â  Â  const box = document.createElement('div');
Â  Â  Â  Â  box.id = 'aiSolverBox';

Â  Â  Â  Â  Object.assign(box.style, {
Â  Â  Â  Â  Â  Â  position: 'fixed', top: '60px', left: 'auto', right: '20px',
Â  Â  Â  Â  Â  Â  zIndex: '99999',
Â  Â  Â  Â  Â  Â  background: '#1e1e1e',
Â  Â  Â  Â  Â  Â  border: '2px solid #7c4dff',
Â  Â  Â  Â  Â  Â  borderRadius: '12px',
Â  Â  Â  Â  Â  Â  width: '320px',
Â  Â  Â  Â  Â  Â  color: '#e0e0e0',
Â  Â  Â  Â  Â  Â  boxShadow: '0 8px 24px rgba(0,0,0,0.6)',
Â  Â  Â  Â  Â  Â  display: 'flex', flexDirection: 'column', overflow: 'hidden'
Â  Â  Â  Â  });

Â  Â  Â  Â  const header = document.createElement('div');
Â  Â  Â  Â  Object.assign(header.style, {
Â  Â  Â  Â  Â  Â  display: 'flex', justifyContent: 'space-between', alignItems: 'center',
Â  Â  Â  Â  Â  Â  padding: '10px 15px', background: '#252525', borderBottom: '1px solid #333',
Â  Â  Â  Â  Â  Â  cursor: 'move', userSelect: 'none'
Â  Â  Â  Â  });

Â  Â  Â  Â  header.innerHTML = `
Â  Â  Â  Â  Â  Â  <h4 style="margin:0; color:#b388ff; font-family:Segoe UI;">
Â  Â  Â  Â  Â  Â  Â  Â  ðŸ‘¾ AI Solver <span style="font-size:0.8em; opacity:0.7">v4.8</span>
Â  Â  Â  Â  Â  Â  </h4>
Â  Â  Â  Â  Â  Â  <div style="display:flex; gap:10px;">
Â  Â  Â  Â  Â  Â  Â  Â  <span id="aiMinBtn" style="cursor:pointer; color:#bbb;">_</span>
Â  Â  Â  Â  Â  Â  Â  Â  <span id="aiCloseBtn" style="cursor:pointer; color:#bbb;">âœ–</span>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `;
Â  Â  Â  Â  box.appendChild(header);


Â  Â  Â  Â  const contentDiv = document.createElement('div');
Â  Â  Â  Â  contentDiv.style.padding = '15px';

Â  Â  Â  Â  const keyInput = document.createElement('input');
Â  Â  Â  Â  keyInput.type = 'password';
Â  Â  Â  Â  keyInput.placeholder = 'Paste Gemini API Key';
Â  Â  Â  Â  keyInput.value = GM_getValue('gemini_api_key', '');
Â  Â  Â  Â  Object.assign(keyInput.style, {
Â  Â  Â  Â  Â  Â  width: '100%', padding: '10px', marginBottom: '15px',
Â  Â  Â  Â  Â  Â  background: '#2d2d2d', border: '1px solid #444',
Â  Â  Â  Â  Â  Â  color: '#fff', borderRadius: '6px', outline: 'none'
Â  Â  Â  Â  });
Â  Â  Â  Â  keyInput.addEventListener('change', () => GM_setValue('gemini_api_key', keyInput.value.trim()));
Â  Â  Â  Â  contentDiv.appendChild(keyInput);


Â  Â  Â  Â  const btnContainer = document.createElement('div');
Â  Â  Â  Â  Object.assign(btnContainer.style, { display: 'flex', gap: '10px' });

Â  Â  Â  Â  const solveBtn = document.createElement('button');
Â  Â  Â  Â  solveBtn.textContent = ' solve';
Â  Â  Â  Â  Object.assign(solveBtn.style, {
Â  Â  Â  Â  Â  Â  flex: '2', padding: '10px', background: 'linear-gradient(135deg, #6200ea, #7c4dff)',
Â  Â  Â  Â  Â  Â  color: 'white', border: 'none', borderRadius: '6px', cursor: 'pointer', fontWeight: 'bold'
Â  Â  Â  Â  });

Â  Â  Â  Â  const checkBtn = document.createElement('button');
Â  Â  Â  Â  checkBtn.textContent = 'ðŸ“¡ TEST';
Â  Â  Â  Â  Object.assign(checkBtn.style, {
Â  Â  Â  Â  Â  Â  flex: '1', padding: '10px', background: '#424242',
Â  Â  Â  Â  Â  Â  color: '#e0e0e0', border: '1px solid #555', borderRadius: '6px', cursor: 'pointer'
Â  Â  Â  Â  });

Â  Â  Â  Â  btnContainer.appendChild(solveBtn);
Â  Â  Â  Â  btnContainer.appendChild(checkBtn);
Â  Â  Â  Â  contentDiv.appendChild(btnContainer);


Â  Â  Â  Â  const logArea = document.createElement('div');
Â  Â  Â  Â  Object.assign(logArea.style, {
Â  Â  Â  Â  Â  Â  marginTop: '15px', height: '200px', overflowY: 'auto',
Â  Â  Â  Â  Â  Â  background: '#121212', border: '1px solid #333',
Â  Â  Â  Â  Â  Â  fontSize: '12px', padding: '10px', borderRadius: '6px',
Â  Â  Â  Â  Â  Â  color: '#bbb', fontFamily: 'Consolas, monospace'
Â  Â  Â  Â  });
Â  Â  Â  Â  logArea.id = 'aiLogArea';
Â  Â  Â  Â  contentDiv.appendChild(logArea);
Â  Â  Â  Â  box.appendChild(contentDiv);


Â  Â  Â  Â  const iconWrapper = document.createElement('div');
Â  Â  Â  Â  iconWrapper.id = 'aiIconWrapper';
Â  Â  Â  Â  Object.assign(iconWrapper.style, {
Â  Â  Â  Â  Â  Â  display: 'none', width: '100%', height: '100%',
Â  Â  Â  Â  Â  Â  justifyContent: 'center', alignItems: 'center', cursor: 'pointer',
Â  Â  Â  Â  Â  Â  background: '#1e1e1e', borderRadius: '50%'
Â  Â  Â  Â  });
Â  Â  Â  Â  iconWrapper.innerHTML = `<div style="font-size:24px;">ðŸ‘¾</div>`;
Â  Â  Â  Â  box.appendChild(iconWrapper);

Â  Â  Â  Â  document.body.appendChild(box);

Â  Â  Â  Â  solveBtn.onclick = async () => {
Â  Â  Â  Â  Â  Â  const apiKey = keyInput.value.trim();
Â  Â  Â  Â  Â  Â  if (!apiKey) return log(' Error: No API Key provided.', '#ff5252');
Â  Â  Â  Â  Â  Â  await runSolver(apiKey);
Â  Â  Â  Â  };
Â  Â  Â  Â  checkBtn.onclick = async () => {
Â  Â  Â  Â  Â  Â  const apiKey = keyInput.value.trim();
Â  Â  Â  Â  Â  Â  if (!apiKey) return log(' Error: No API Key provided.', '#ff5252');
Â  Â  Â  Â  Â  Â  await checkApiStatus(apiKey);
Â  Â  Â  Â  };

Â  Â  Â  Â  header.querySelector('#aiCloseBtn').onclick = () => box.remove();
Â  Â  Â  Â  const minBtn = header.querySelector('#aiMinBtn');
Â  Â  Â  Â  const toggleMin = (min) => {
Â  Â  Â  Â  Â  Â  contentDiv.style.display = min ? 'none' : 'block';
Â  Â  Â  Â  Â  Â  header.style.display = min ? 'none' : 'flex';
Â  Â  Â  Â  Â  Â  iconWrapper.style.display = min ? 'flex' : 'none';
Â  Â  Â  Â  Â  Â  box.style.width = min ? '50px' : '320px';
Â  Â  Â  Â  Â  Â  box.style.height = min ? '50px' : 'auto';
Â  Â  Â  Â  Â  Â  box.style.borderRadius = min ? '50%' : '12px';
Â  Â  Â  Â  Â  Â  box.style.border = min ? '2px solid #b388ff' : '2px solid #7c4dff';
Â  Â  Â  Â  };
Â  Â  Â  Â  minBtn.onclick = () => toggleMin(true);
Â  Â  Â  Â  iconWrapper.onclick = () => toggleMin(false);
Â  Â  Â  Â  makeDraggable(box, header);
Â  Â  Â  Â  makeDraggable(box, iconWrapper);
Â  Â  }

Â  Â  function makeDraggable(element, handle) {
Â  Â  Â  Â  let pos1=0, pos2=0, pos3=0, pos4=0;
Â  Â  Â  Â  handle.onmousedown = (e) => {
Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  const rect = element.getBoundingClientRect();
Â  Â  Â  Â  Â  Â  element.style.left = rect.left + "px"; element.style.top = rect.top + "px"; element.style.right = "auto";
Â  Â  Â  Â  Â  Â  pos3 = e.clientX; pos4 = e.clientY;
Â  Â  Â  Â  Â  Â  document.onmouseup = () => { document.onmouseup = null; document.onmousemove = null; };
Â  Â  Â  Â  Â  Â  document.onmousemove = (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  Â  Â  pos1 = pos3 - e.clientX; pos2 = pos4 - e.clientY;
Â  Â  Â  Â  Â  Â  Â  Â  pos3 = e.clientX; pos4 = e.clientY;
Â  Â  Â  Â  Â  Â  Â  Â  element.style.top = (element.offsetTop - pos2) + "px";
Â  Â  Â  Â  Â  Â  Â  Â  element.style.left = (element.offsetLeft - pos1) + "px";
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  };
Â  Â  }

Â  Â  function log(msg, color = '#e0e0e0', isBold = false) {
Â  Â  Â  Â  const area = document.getElementById('aiLogArea');
Â  Â  Â  Â  if(area) {
Â  Â  Â  Â  Â  Â  const line = document.createElement('div');
Â  Â  Â  Â  Â  Â  line.style.marginBottom = '6px'; line.style.borderBottom = '1px solid #222'; line.style.paddingBottom = '4px';
Â  Â  Â  Â  Â  Â  line.style.color = color; if (isBold) line.style.fontWeight = 'bold';
Â  Â  Â  Â  Â  Â  line.innerHTML = msg;
Â  Â  Â  Â  Â  Â  area.appendChild(line); area.scrollTop = area.scrollHeight;
Â  Â  Â  Â  }
Â  Â  Â  Â  console.log('[AI Solver]', msg.replace(/<[^>]*>?/gm, ''));
Â  Â  }

Â  Â  function checkApiStatus(apiKey) {
Â  Â  Â  Â  log('ðŸ“¡ Ping Gemini...', '#b388ff');
Â  Â  Â  Â  GM_xmlhttpRequest({
Â  Â  Â  Â  Â  Â  method: "POST", url: `${API_URL}?key=${apiKey}`,
Â  Â  Â  Â  Â  Â  headers: { "Content-Type": "application/json" },
Â  Â  Â  Â  Â  Â  data: JSON.stringify({ contents: [{ parts: [{ text: "Reply with 'OK'" }] }] }),
Â  Â  Â  Â  Â  Â  onload: function(res) {
Â  Â  Â  Â  Â  Â  Â  Â  if (res.status === 200) log(' API is Ready!', '#00e676', true);
Â  Â  Â  Â  Â  Â  Â  Â  else if (res.status === 429) log(' Rate Limited.', '#ffab40', true);
Â  Â  Â  Â  Â  Â  Â  Â  else log(` Error: ${res.status}`, '#ff5252');
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  onerror: function() { log(' Network Error', '#ff5252'); }
Â  Â  Â  Â  });
Â  Â  }

Â  Â  async function runSolver(apiKey) {
Â  Â  Â  Â  log(`Starting...`, '#b388ff');
Â  Â  Â  Â  const questions = document.querySelectorAll('.que.multichoice');
Â  Â  Â  Â  log(`Found ${questions.length} questions.`, '#b388ff');
Â  Â  Â  Â  if (questions.length === 0) return log(' No questions found.', '#ff5252');

Â  Â  Â  Â  let solved = 0;
Â  Â  Â  Â  let flaggedQuestions = []; 

Â  Â  Â  Â  for (let i = 0; i < questions.length; i++) {
Â  Â  Â  Â  Â  Â  const qBlock = questions[i];
Â  Â  Â  Â  Â  Â  const qTextElem = qBlock.querySelector('.qtext');
Â  Â  Â  Â  Â  Â  if (!qTextElem) continue;

Â  Â  Â  Â  Â  Â  const qText = qTextElem.innerText.trim();
Â  Â  Â  Â  Â  Â  const optionRows = qBlock.querySelectorAll('.answer div[class^="r"]');
Â  Â  Â  Â  Â  Â  let optionsText = [], radioInputs = [];

Â  Â  Â  Â  Â  Â  optionRows.forEach(row => {
Â  Â  Â  Â  Â  Â  Â  Â  const label = row.querySelector('label');
Â  Â  Â  Â  Â  Â  Â  Â  const input = row.querySelector('input[type="radio"]');
Â  Â  Â  Â  Â  Â  Â  Â  if (label && input) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  optionsText.push(label.innerText.replace(/^[a-z]\.\s*/i, '').trim());
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  radioInputs.push(input);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  if (optionsText.length === 0) continue;

Â  Â  Â  Â  Â  Â  qBlock.style.transition = "border 0.3s";
Â  Â  Â  Â  Â  Â  qBlock.style.borderLeft = "5px solid #7c4dff";
Â  Â  Â  Â  Â  Â  qBlock.scrollIntoView({ behavior: 'smooth', block: 'center' });

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const result = await callGeminiWithRetry(apiKey, qText, optionsText);

Â  Â  Â  Â  Â  Â  Â  Â  if (result && result.index !== null && result.index >= 0 && result.index < radioInputs.length) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  radioInputs[result.index].click();

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let confColor = '#00e676';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (result.confidence < 50) { confColor = '#ff5252'; flaggedQuestions.push(`Q${i+1}`); }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if (result.confidence < 80) { confColor = '#ffab40'; flaggedQuestions.push(`Q${i+1}`); }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  qBlock.style.borderLeft = `5px solid ${confColor}`;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const displayQ = qText.length > 100 ? qText.substring(0, 97) + "..." : qText;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  log(` Q${i+1}: ${displayQ}`, '#40c4ff', true);

Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  log(`=> ${optionsText[result.index]}`, '#e0e0e0');
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  log(`<span style="font-size:0.9em; opacity:0.8;">(Confidence: ${result.confidence}%)</span>`, confColor);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  solved++;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  qBlock.style.borderLeft = "5px solid #ff5252";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  log(` Q${i+1}: Uncertain.`, '#ff5252');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  Â  Â  qBlock.style.borderLeft = "5px solid #ff5252";
Â  Â  Â  Â  Â  Â  Â  Â  log(` Q${i+1}: ${err.message}`, '#ff5252');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  await new Promise(r => setTimeout(r, 1000));
Â  Â  Â  Â  }

Â  Â  Â  Â  log(` DONE. Solved ${solved}/${questions.length}`, '#b388ff');


Â  Â  Â  Â  if (flaggedQuestions.length > 0) {
Â  Â  Â  Â  Â  Â  log(` Check these: ${flaggedQuestions.join(', ')}`, '#ffab40', true);
Â  Â  Â  Â  }
Â  Â  }

Â  Â  async function callGeminiWithRetry(apiKey, question, options) {
Â  Â  Â  Â  let attempts = 0;
Â  Â  Â  Â  while (attempts < 3) {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  return await callGemini(apiKey, question, options);
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  if (error.message.includes("429")) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  attempts++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  log(`Rate Limit. Pausing 5s...`, '#ffab40');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await new Promise(r => setTimeout(r, 5000));
Â  Â  Â  Â  Â  Â  Â  Â  } else throw error;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  throw new Error("Failed after 3 retries");
Â  Â  }

Â  Â  function callGemini(apiKey, question, options) {
Â  Â  Â  Â  return new Promise((resolve, reject) => {
Â  Â  Â  Â  Â  Â  const prompt = `Question: ${question}\nOptions:\n${options.map((o,i)=>`${i}. ${o}`).join('\n')}\nTask: Identify correct answer & confidence (0-100).\nOutput: "INDEX|CONFIDENCE" (e.g. 2|95).`;
Â  Â  Â  Â  Â  Â  GM_xmlhttpRequest({
Â  Â  Â  Â  Â  Â  Â  Â  method: "POST", url: `${API_URL}?key=${apiKey}`,
Â  Â  Â  Â  Â  Â  Â  Â  headers: { "Content-Type": "application/json" },
Â  Â  Â  Â  Â  Â  Â  Â  data: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }),
Â  Â  Â  Â  Â  Â  Â  Â  onload: function(res) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (res.status === 429) return reject(new Error("429"));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (res.status !== 200) return reject(new Error(`API Error ${res.status}`));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const text = JSON.parse(res.responseText).candidates[0].content.parts[0].text.trim();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const parts = text.split('|');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (parts.length === 2) resolve({ index: parseInt(parts[0]), confidence: parseInt(parts[1]) });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else resolve({ index: parseInt(text.match(/\d+/)[0]), confidence: 0 });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch (e) { reject(new Error("Parse Error")); }
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  onerror: () => reject(new Error("Network Error"))
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });
Â  Â  }

Â  Â  window.addEventListener('keydown', e => {
Â  Â  Â  Â  if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'f') addUI();
Â  Â  });
})();
